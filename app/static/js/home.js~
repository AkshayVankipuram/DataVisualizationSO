$(function() {
    $('#filters .filter > div').each(function() {
        $(this).empty().slider({
            orientation: "horizontal",
            range: "min",
            max: 500,
            value: 200
        });
    });

    $('#dropdown').button({
        text: false
    });

    queue()
        .defer(d3.json,$RESOURCES+'/topic_sim.json')
        .defer(d3.json,$RESOURCES+'/topics.json')
        .await(draw);

    function draw(err,matrix, root) {
        var margin = {top: 55, right: 10, bottom: 10, left: 40},
            width = $('#chartContainer').width(),
            height = $('#chartContainer').height() * .75,
            outerRadius = Math.min(width, height) / 2,
            innerRadius = outerRadius - 24;

        var arc = d3.svg.arc()
            .innerRadius(innerRadius)
            .outerRadius(outerRadius);

        var layout = d3.layout.chord()
                .padding(.04)
                .sortSubgroups(d3.descending)
                .sortChords(d3.ascending)
                .matrix(matrix);

        var path = d3.svg.chord()
                .radius(innerRadius);

        var svg = d3.select("#chartContainer").append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                    .attr("id", "circle")
                    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

        svg.append("circle")
                .attr("r", outerRadius);

        // Add a group per neighborhood.
	    var group = svg.selectAll(".group")
            .data(layout.groups)
              .enter().append("g")
            .attr("class", "group")
            .on("mouseover", mouseover)
            .on('click', click);

	    // Add a mouseover title.
	    group.append("title").text(function(d, i) {
	      return "Topic"+i;
	    });

	    // Add the group arc.
	    var groupPath = group.append("path")
		.attr("id", function(d, i) { return "group" + i; })
		.attr("d", arc)
		.style("fill", function(d, i) { return "steelblue"; });

	    // Add a text label.
	    var groupText = group.append("text")
		.attr("x", 6)
		.attr("dy", 15);

	    groupText.append("textPath")
		.attr("xlink:href", function(d, i) { return "#group" + i; })
		.text(function(d, i) { return i; });

	    // Add the chords.
	    var chord = svg.selectAll(".chord")
            .data(layout.chords)
              .enter().append("path")
            .attr("class", "chord")
            .style("fill", function(d) { return "steelblue"; })
            .attr("d", path);

	    // Add an elaborate mouseover title for each chord.
	    chord.append("title").text(function(d) {
            return"Nothing";
	    });
        
        function mouseover(d, i) {
            chord.classed("permfade",false);
            chord.classed("fade", function(p) {
                    return p.source.index != i
                                && p.target.index != i;
                });
        }    

        function click(d, i) {
            chord.classed("permfade", false);
            chord.classed("permfade", function(p) {
                return p.source.index != i
                        && p.target.index != i;
            });
        }
    }

    function radar() {
    }
});
